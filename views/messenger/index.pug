extend ./layout

block contentMain
  #main.ps-rv.chat-page
    #main-messenger.d-flex.ps-rv
      #main-left.p-3.d-flex.flex-column
        #main-left-top.d-flex.justify-content-between.align-items-center
          h4.mb-0 Chat
          #room.d-flex.align-items-center.justify-content-center
            span.text-secondary.mr-3 Phòng chat 
            a.btn.btn-icon.btn-green(href="/create", role="button", title="Tạo phòng")
              span.icomoon.icon-plus
            a.btn.btn-icon.btn-purple.ml-2(href="/join", role="button", title="Tham gia vào phòng")
              span.icomoon.icon-sign-in
        #main-left-search.mt-2
          form.ps-rv.form-search-friend
            label.sr-only(for="search-friend")
            input#search-friend.form-control(type="text", name="q", placeholder="Tìm bạn bè để chat", autocomplete="off")
            span.icomoon.icon-icon-search
            .search-fri-res-box.d-none
              .loader-search.d-none.text-center
                img(src="/images/loader.svg" alt="loader")
              .s-fri-res-box
                .text-center.last-mb-none
                  p Kết quả tìm kiếm
                
        #main-left-friends.mt-2.flex-fill
          each friend in friends
            .friend-item.mt-1.ps-rv(class=`${friendChat ? friend.id === friendChat.id ? "is-active": "" : ""} ${friend.status === 'online' ? "is-online" : ""}`, data-id=friend.id)
              .friend-item-main.d-flex
                .friend-item-img.ps-rv
                  div.dot-status
                  img.rounded-circle(src=friend.avatar, alt=friend.name, width="45px")
                .friend-item-info.ml-2
                  strong= friend.name
                  .last-msg.text-dark.un-read
                    if (friend.latestMessage)
                      small= friend.latestMessage.msg
                      small= friend.latestMessage.timeFromNow
              a.ps-as(href=`/messenger/chat/${friend.url ? friend.url : friend.id}`, title=`${friend.name}`)
                span.sr-only= `Chat with ${friend.name}`

      if (friendChat)
        #main-right.flex-fill.d-flex.flex-column.ps-rv(data-id=friendChat.id)
          .dragzone.d-none
            .d-flex.justify-content-center.align-items-center.h-100.drag-inner
              div
                .text-center
                  span.icomoon.icon-insert_drive_file
                h4 Kéo thả tệp vào đây
          #main-right-top.d-flex.justify-content-between.p-2.align-items-center
            #main-right-top-left.d-flex
              .friend-img
                img.rounded-circle(src=friendChat.avatar, alt=friendChat.name, width="45px")
              .friend-info.ml-2
                strong= friendChat.name
                br
                small.text-status !{statusText}
            #main-right-top-right.d-flex
              button#call-friend-btn.btn.btn-icon.small-btn.btn-green(type="button", title="Gọi").mr-2
                span.icomoon.icon-phone
              button#video-friend-btn.btn.btn-icon.small-btn.btn-purple(type="button", title="Gọi video")
                span.icomoon.icon-camera
          .wrap-msg-box.ps-rv.flex-fill
            .wrap-loader-chat.d-none
              img(src="/images/loader.svg", alt="loader")
            .scroll-bottom
              span.icomoon.icon-circle-down
            #main-right-chat-content.p-2.h-100
              each msg in messagesActive
                if (msg.me)
                  .message.text-right(class=msg.class)
                    small.message-time= msg.time
                    div
                      .msg-me
                        if (msg.fileName)
                          small.message-content.mx-0
                            if (msg.type === 'image')
                              img.pre-img(src=msg.content, alt=msg.fileName)
                            else if (msg.type === 'video')
                              video.pre-video(src=msg.content, autoplay, muted, loop)
                            else
                              a(href=msg.content, target="_blank")= msg.fileName
                        else if (msg.isLink)
                          small.message-content.mx-0
                            a(href=msg.content, target="_blank")= msg.content
                        else
                          small.message-content.mx-0= msg.content
                        if (msg.timeCall)
                          small.time-call= msg.timeCall
                else
                  .message(class=msg.class)
                    small.message-time= msg.time
                    div
                      .msg
                        img.message-avatar(src=msg.avatar, alt=msg.name)
                        if (msg.fileName)
                          small.message-content
                            if (msg.type === 'image')
                              img.pre-img(src=msg.content, alt=msg.fileName)
                            else if (msg.type === 'video')
                              video.pre-video(src=msg.content, autoplay, muted, loop)
                            else
                              a(href=msg.content, target="_blank")= msg.fileName
                        else if (msg.isLink)
                          small.message-content
                            a(href=msg.content, target="_blank")= msg.content
                        else
                          small.message-content= msg.content
                        if (msg.timeCall)
                          small.time-call= msg.timeCall

          #main-right-top-chat-input.mb-1.px-2.wrap-chat-input.ps-rv
            .files-upload-box.d-flex.justify-content-center.flex-wrap
            form.d-flex(name="sendMsgForm", method="post")
              label.btn.btn-default.send-file.m-0.p-2(for="send-file")
                span.icomoon.icon-insert_drive_file
              input#send-file.d-none(type="file", name="file", multiple)
              button.btn.btn-default.send-take-photo.m-0.p-2(data-toggle="modal", data-target="#modal-take-photo")
                span.icomoon.icon-camera
              button.btn.btn-default.send-rec.m-0.p-2
                span.icomoon.icon-mic
              button.btn.btn-default.open-emojis(type="button") &#128512;
              input(type="hidden", name="_token", value=token)
              .flex-fill.wrap-msg-box.ps-rv
                textarea#msg.form-control(name="message", placeholder="Nhập tin nhắn", autocomplete="off")
              button.btn.btn-default.text-secondary
                span.icomoon.icon-send

    .overlay-calling.d-none.ps-as

  #modal-take-photo.modal.fade(tabindex='-1', aria-labelledby='modal-take-photo', aria-hidden='true')
    .modal-dialog.modal-dialog-centered
      .modal-content
        .modal-header.align-items-center
          h4.modal-title Chụp ảnh
          button.close(type='button', data-dismiss='modal', aria-label='Close')
            span(aria-hidden='true') &times;
        .modal-body
          .wrap-photo.d-none
            .photo-pre.mb-3
            .text-center
              button#send-photo-btn.btn(type="button") Gửi
              button#re-take-btn.btn.btn-white.ml-3(type="button") Chụp lại
          .wrap-takephoto
            .count-down.d-none.ps-as
              .wrap-num-cd.d-flex.justify-content-center.align-items-center.ps-as
                -var n = 3
                  while n > 0 
                    span(class='cd-num' + n)= n--
            video(autoplay=true, muted=true, controls=false)

append scripts
  script(src="/js/home-messenger.js")
//-   script(src="/scripts/moment.min.js")
//-   script(src="/scripts/emoji.js")
//-   script(src="/scripts/common-chat.js")
  